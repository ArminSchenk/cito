<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="cito">
<title>Advanced: Custom loss functions and prediction intervals â€¢ cito</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced: Custom loss functions and prediction intervals">
<meta property="og:description" content="cito">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">cito</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/A-Introduction_to_cito.html">Introduction to cito</a>
    <a class="dropdown-item" href="../articles/B-Training_neural_networks.html">Training neural networks</a>
    <a class="dropdown-item" href="../articles/C-Example_Species_distribution_modeling.html">Example: (Multi-) Species distribution models with cito</a>
    <a class="dropdown-item" href="../articles/D-Advanced_custom_loss_functions.html">Advanced: Custom loss functions and prediction intervals</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/citoverse/cito/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Advanced: Custom loss functions and prediction intervals</h1>
                        <h4 data-toc-skip class="author">Maximilian
Pichler</h4>
            
            <h4 data-toc-skip class="date">2023-09-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/citoverse/cito/blob/HEAD/vignettes/D-Advanced_custom_loss_functions.Rmd" class="external-link"><code>vignettes/D-Advanced_custom_loss_functions.Rmd</code></a></small>
      <div class="d-none name"><code>D-Advanced_custom_loss_functions.Rmd</code></div>
    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      This vignette shows how cito can be used for advanced techniques
      such as custom loss functions.
    </div>
    
<div class="section level2">
<h2 id="custom-loss-functions">Custom loss functions<a class="anchor" aria-label="anchor" href="#custom-loss-functions"></a>
</h2>
<p>We can pass custom loss functions to cito. R variables/values that
are used within the loss function and that should be additionally
optimized must be passed to cito via the custom_parameters argument in
<code>dnn(...custom_parameters = list(name_of_parameter=...))</code></p>
<p>Examples:</p>
<ul>
<li>(Complex) likelihood functions</li>
<li>Advanced: Quantile regression</li>
</ul>
<p>Requirements: - Complex calculations have to be written in torch -
All functions/calls must have derivatives.</p>
<div class="section level3">
<h3 id="example-1-custom-likelihoodloss-functions">Example 1: Custom (likelihood/loss) functions<a class="anchor" aria-label="anchor" href="#example-1-custom-likelihoodloss-functions"></a>
</h3>
<p>Gaussian likelihood (already implemented, but still a nice example).
Custom parameters must be passed as a list to the custom_parameters
function. The names must match the names of the parameters in the custom
loss function. The values of the named custom parameters will be the
initial values. Cito will automatically convert them to torch
tensors:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://citoverse.github.io/cito/" class="external-link">cito</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="va">gaussian_ll</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pred</span>, <span class="va">true</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="op">-</span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/distr_normal.html" class="external-link">distr_normal</a></span><span class="op">(</span><span class="va">pred</span>, scale <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_exp.html" class="external-link">torch_exp</a></span><span class="op">(</span><span class="va">scale_par</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">log_prob</span><span class="op">(</span><span class="va">true</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">loss</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Simulate some data</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span>, sd <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>, data <span class="op">=</span> <span class="va">df</span>, </span>
<span>        loss <span class="op">=</span> <span class="va">gaussian_ll</span>, <span class="co"># custom function </span></span>
<span>        verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        custom_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scale_par <span class="op">=</span> <span class="fl">0.0</span><span class="op">)</span> <span class="co"># custom parameter that should be addtionally optimized</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
<p><img src="D-Advanced_custom_loss_functions_files/figure-html/unnamed-chunk-2-1.png" width="400px" style="display: block; margin: auto;"></p>
<p>The optimized parameters are saved in the parameter field:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">scale_par</span><span class="op">)</span> <span class="co"># true scale parameter: 0.4!</span></span>
<span><span class="co">#&gt; [1] 0.4272134</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-2-quantile-regression">Example 2: Quantile regression<a class="anchor" aria-label="anchor" href="#example-2-quantile-regression"></a>
</h3>
<p>The bootstrapping approach provides confidence intervals, but not
prediction intervals. We could use likelihoods, such as the Gaussian
likelihood, to fit a constant prediction interval. However, we often use
loss functions, such as the mean squared error in ML/DL, which donâ€™t
have an intrinsic parametrization for prediction intervals. We can
approximate prediction intervals with quantile regression (a form of
conformal prediction), which has the advantage of providing constant
prediction intervals, which can be beneficial in certain situations
(e.g., heteroscedasticity):</p>
<p>Simulate data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_in</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">S</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1.</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">S</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span><span class="op">=</span><span class="va">S</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span><span class="op">=</span><span class="fl">0.0</span></span>
<span>  <span class="va">X</span> <span class="op">=</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="va">n</span>, sigma <span class="op">=</span> <span class="va">S</span><span class="op">)</span></span>
<span>  <span class="va">X1</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">C</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">X2</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="fl">1</span><span class="op">*</span><span class="va">X1</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">*</span><span class="va">X2</span> <span class="op">+</span> <span class="fl">0.0</span><span class="op">*</span><span class="va">C</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="fl">1.8</span><span class="op">^</span><span class="op">(</span><span class="va">X1</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, X1 <span class="op">=</span> <span class="va">X1</span>, X2 <span class="op">=</span> <span class="va">X2</span>, C <span class="op">=</span> <span class="va">C</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu">sim_in</span><span class="op">(</span><span class="fl">500L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span></code></pre></div>
<p><img src="D-Advanced_custom_loss_functions_files/figure-html/unnamed-chunk-4-1.png" width="400px" style="display: block; margin: auto;"></p>
<p>The variance increases with higher feature values</p>
<p>Quantile Regression:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">q1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">q2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">q3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="va">loss_func</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pred</span>, <span class="va">true</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">l1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_max.html" class="external-link">torch_max</a></span><span class="op">(</span><span class="va">q1</span><span class="op">*</span><span class="op">(</span><span class="va">true</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>, other <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span><span class="op">-</span><span class="va">q1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">true</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">l2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_max.html" class="external-link">torch_max</a></span><span class="op">(</span><span class="va">q2</span><span class="op">*</span><span class="op">(</span><span class="va">true</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>, other <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span><span class="op">-</span><span class="va">q2</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">true</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">l3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_max.html" class="external-link">torch_max</a></span><span class="op">(</span><span class="va">q3</span><span class="op">*</span><span class="op">(</span><span class="va">true</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>, other <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span><span class="op">-</span><span class="va">q3</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">pred</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">-</span><span class="va">true</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">l1</span><span class="op">+</span><span class="va">l2</span><span class="op">+</span><span class="va">l3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">Y</span>, <span class="va">Y</span><span class="op">)</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>, </span>
<span>        lr <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>        loss <span class="op">=</span> <span class="va">loss_func</span>,</span>
<span>        lambda <span class="op">=</span> <span class="fl">0.000</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>        epochs <span class="op">=</span> <span class="fl">70L</span>, hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30L</span>, <span class="fl">30L</span><span class="op">)</span>, </span>
<span>        activation <span class="op">=</span> <span class="st">"selu"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: 5.271382, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 2: 4.994545, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 3: 4.740418, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 4: 4.275611, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 5: 3.901660, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 6: 3.616717, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 7: 3.344618, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 8: 3.199994, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 9: 3.054611, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 2.969413, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 11: 2.921340, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 12: 2.916588, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 13: 2.885472, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 14: 2.834176, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 15: 2.832779, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 16: 2.844234, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 17: 2.875691, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 18: 2.801808, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 19: 2.779784, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 2.807058, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 21: 2.782664, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 22: 2.756759, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 23: 2.755162, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 24: 2.740886, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 25: 2.749535, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 26: 2.755240, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 27: 2.741033, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 28: 2.760876, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 29: 2.733894, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 2.733609, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 31: 2.737270, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 32: 2.733017, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 33: 2.735549, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 34: 2.735473, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 35: 2.751014, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 36: 2.731150, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 37: 2.723879, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 38: 2.716434, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 39: 2.726275, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 2.710793, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 41: 2.735267, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 42: 2.742130, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 43: 2.723750, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 44: 2.722506, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 45: 2.732910, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 46: 2.729110, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 47: 2.738021, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 48: 2.743067, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 49: 2.720707, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 2.704528, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 51: 2.709313, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 52: 2.731718, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 53: 2.704233, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 54: 2.720177, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 55: 2.707666, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 56: 2.733724, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 57: 2.715642, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 58: 2.727626, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 59: 2.701437, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 60: 2.713740, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 61: 2.725515, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 62: 2.705921, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 63: 2.719956, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 64: 2.705411, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 65: 2.721525, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 66: 2.725577, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 67: 2.728728, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 68: 2.697947, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 69: 2.715803, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 70: 2.688323, lr: 0.01000</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">smooth.spline</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, spar <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">smooth.spline</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, spar <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">smooth.spline</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, spar <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="D-Advanced_custom_loss_functions_files/figure-html/unnamed-chunk-5-1.png" width="400px" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="example-3-using-cito-for-optimization">Example 3: Using cito for optimization<a class="anchor" aria-label="anchor" href="#example-3-using-cito-for-optimization"></a>
</h3>
<p>We can use neural networks in an unconventional way to optimize
arbitrary functions - as long as we can compute the analytic derivative
of the function using torch. We need to provide the function to be
optimized as a series of Torch operations. Our model will predict the
parameters (based on noise, the inputs donâ€™t matter), in the custom loss
function we will then use the model function (we want to optimize) to
compute the loss and return it to the optimizer. In that way we overfit
to the noisy inputs and the DNN will learn to predict the optimal set of
parameters - independent of the input.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span>, sd <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function we want to optimize (linear model)</span></span>
<span><span class="va">Xt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Yt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_lm</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="va">Xt</span><span class="op">$</span><span class="fu">matmul</span><span class="op">(</span><span class="va">par</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="op">-</span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/distr_normal.html" class="external-link">distr_normal</a></span><span class="op">(</span><span class="va">pred</span>, scale <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_exp.html" class="external-link">torch_exp</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">log_prob</span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">loss</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">custom_loss</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pred</span>, <span class="va">true</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_zeros.html" class="external-link">torch_zeros</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="co"># disable loss calculation</span></span>
<span>  <span class="va">loss</span> <span class="op">=</span> <span class="fu">model_lm</span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># X and Y values don't matter, number of columns in Y has to match the number of parameters we want to optimize</span></span>
<span><span class="va">noise</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">300</span><span class="op">*</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">300</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">noise_y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">300</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">300</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="va">noise_y</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, y2 <span class="op">=</span> <span class="va">noise_y</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">noise</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">y2</span><span class="op">)</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">df</span>, loss <span class="op">=</span> <span class="va">custom_loss</span>, batchsize <span class="op">=</span> <span class="fl">1L</span>, epochs <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: 0.797603, lr: 0.01000</span></span></code></pre></div>
<p><img src="D-Advanced_custom_loss_functions_files/figure-html/unnamed-chunk-6-1.png" width="400px" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; Loss at epoch 2: 0.505026, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 3: 0.498499, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 4: 0.496815, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 5: 0.496301, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 6: 0.496155, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 7: 0.496078, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 8: 0.496035, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 9: 0.496004, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 0.495980, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 11: 0.495960, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 12: 0.495944, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 13: 0.495925, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 14: 0.495915, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 15: 0.495903, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 16: 0.495892, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 17: 0.495880, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 18: 0.495868, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 19: 0.495866, lr: 0.01000</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 0.495859, lr: 0.01000</span></span>
<span><span class="co"># Effect:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.978484</span></span>
<span><span class="co"># SD</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3968703</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Christian AmesÃ¶der, Maximilian Pichler.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
