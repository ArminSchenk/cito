<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Training neural networks • cito</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Training neural networks">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cito</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/A-Introduction_to_cito.html">Introduction to cito</a></li>
    <li><a class="dropdown-item" href="../articles/B-Training_neural_networks.html">Training neural networks</a></li>
    <li><a class="dropdown-item" href="../articles/C-Example_Species_distribution_modeling.html">Example: (Multi-) Species distribution models with cito</a></li>
    <li><a class="dropdown-item" href="../articles/D-Advanced_custom_loss_functions.html">Advanced: Custom loss functions and prediction intervals</a></li>
    <li><a class="dropdown-item" href="../articles/E-CNN_and_MMN.html">Convultions neural networks and Multi modal neural networks</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/citoverse/cito/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Training neural networks</h1>
                        <h4 data-toc-skip class="author">Maximilian
Pichler</h4>
            
            <h4 data-toc-skip class="date">2024-03-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/citoverse/cito/blob/HEAD/vignettes/B-Training_neural_networks.Rmd" class="external-link"><code>vignettes/B-Training_neural_networks.Rmd</code></a></small>
      <div class="d-none name"><code>B-Training_neural_networks.Rmd</code></div>
    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      This vignette helps to address certain problems that occur when
      training neural networks (NN) and gives hints on how to increase
      the likelihood of their convergence.
    </div>
    
<div class="section level2">
<h2 id="possible-issues">Possible issues<a class="anchor" aria-label="anchor" href="#possible-issues"></a>
</h2>
<ul>
<li>
<p>Convergence issues, (often because of the learning rate),
<strong>training loss above baseline loss</strong>:</p>
<p><img src="B%2FB-unnamed-chunk-2-1.png" style="display: block; margin: auto;"></p>
<p>If it looks like that, go to the <a href="#lr">adjusting the learning
rate section</a></p>
</li>
<li>
<p>Overfitting, difference between training and testing/holdout/new
data error is too high, or validation loss first decreases but then
increases again:</p>
<p><img src="B%2FB-unnamed-chunk-3-1.png" style="display: block; margin: auto;"></p>
<p>if it loos like that, go to the <a href="#overfitting">overfitting
section</a></p>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="lr">Convergence issues<a class="anchor" aria-label="anchor" href="#lr"></a>
</h2>
<p>Ensuring convergence can be tricky when training neural networks.
Their training is sensitive to a combination of the learning rate (how
much the weights are updated in each optimization step), the batch size
(a random subset of the data is used in each optimization step), and the
number of epochs (number of optimization steps).</p>
<div class="section level3">
<h3 id="epochs">Epochs<a class="anchor" aria-label="anchor" href="#epochs"></a>
</h3>
<p>Give the neural network enough time to learn. The epochs should be
high enough so that the training loss “stabilizes”:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span>, epochs <span class="op">=</span> <span class="fl">10L</span>, loss <span class="op">=</span> <span class="st">"softmax"</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="B%2FB-unnamed-chunk-4-1.png" style="display: block; margin: auto;"></p>
<p>After 10 epochs the loss was still decreasing, we should train the
model longer (increase epochs):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span>, epochs <span class="op">=</span> <span class="fl">200L</span>, loss <span class="op">=</span> <span class="st">"softmax"</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="B%2FB-unnamed-chunk-5-1.png" style="display: block; margin: auto;"></p>
<p>Here, it takes around 190-200 epochs until the loss doesn’t decrease
anymore. The “speed” of the learning depends also on the learning rate.
Higher rates means larger steps into direction of local minima in the
loss function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span>, epochs <span class="op">=</span> <span class="fl">200L</span>, loss <span class="op">=</span> <span class="st">"softmax"</span>, lr <span class="op">=</span> <span class="fl">0.05</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="B%2FB-unnamed-chunk-6-1.png" style="display: block; margin: auto;"></p>
<p>Now it only takes about 100 epochs, but we also see that the training
loss becomes wobbly. Larger learning rates increase the probability that
local minima are skipped and the optimizer has problems to hit a
minima.</p>
<p>Note: But if the learning rate is high, or too high, the loss will
get “jumpy”, the risk of the optimizer jumping over local minima
increases (see next section).</p>
</div>
<div class="section level3">
<h3 id="learning-rate">Learning rate<a class="anchor" aria-label="anchor" href="#learning-rate"></a>
</h3>
<p>Typically, the learning rate should be decreased with the size of the
neural networks (depth of the network and width of the hidden layers).
We provide a baseline loss (intercept only model) that can give hints
about an appropriate learning rate.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nn.fit_good</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html" class="external-link">iris</a></span>, lr <span class="op">=</span> <span class="fl">0.09</span>, epochs <span class="op">=</span> <span class="fl">20L</span>, loss <span class="op">=</span> <span class="st">"softmax"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">nn.fit_high</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html" class="external-link">iris</a></span>, lr <span class="op">=</span> <span class="fl">2.09</span>, epochs <span class="op">=</span> <span class="fl">20L</span>, loss <span class="op">=</span> <span class="st">"softmax"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">nn.fit_low</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html" class="external-link">iris</a></span>, lr <span class="op">=</span> <span class="fl">0.00000001</span>, epochs <span class="op">=</span> <span class="fl">20L</span>, loss <span class="op">=</span> <span class="st">"softmax"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">cito</span><span class="fu">:::</span><span class="fu">visualize.training</span><span class="op">(</span><span class="va">nn.fit_good</span><span class="op">$</span><span class="va">losses</span>,main<span class="op">=</span><span class="st">"Training loss"</span>, epoch <span class="op">=</span> <span class="fl">20</span>, new <span class="op">=</span> <span class="cn">TRUE</span>, baseline <span class="op">=</span> <span class="va">nn.fit_good</span><span class="op">$</span><span class="va">base_loss</span><span class="op">)</span></span>
<span><span class="fu">cito</span><span class="fu">:::</span><span class="fu">visualize.training</span><span class="op">(</span><span class="va">nn.fit_high</span><span class="op">$</span><span class="va">losses</span>,main<span class="op">=</span><span class="st">"Training loss"</span>, epoch <span class="op">=</span> <span class="fl">20</span>, new <span class="op">=</span> <span class="cn">TRUE</span>, baseline <span class="op">=</span> <span class="va">nn.fit_good</span><span class="op">$</span><span class="va">base_loss</span><span class="op">)</span></span>
<span><span class="fu">cito</span><span class="fu">:::</span><span class="fu">visualize.training</span><span class="op">(</span><span class="va">nn.fit_low</span><span class="op">$</span><span class="va">losses</span>,main<span class="op">=</span><span class="st">"Training loss"</span>, epoch <span class="op">=</span> <span class="fl">20</span>, new <span class="op">=</span> <span class="cn">TRUE</span>, baseline <span class="op">=</span> <span class="va">nn.fit_good</span><span class="op">$</span><span class="va">base_loss</span><span class="op">)</span></span></code></pre></div>
<p><img src="B%2FB-unnamed-chunk-7-1.png" style="display: block; margin: auto;"></p>
<p>If the training loss of the model doesn’t fall below the baseline
loss, the learning rate is either too high or too low. If this happens,
try higher and lower learning rates.</p>
<p>A common strategy is to try (manually) a few different learning rates
to see if the learning rate is on the right scale.</p>
</div>
<div class="section level3">
<h3 id="solution-learning-rate-scheduler">Solution: learning rate scheduler<a class="anchor" aria-label="anchor" href="#solution-learning-rate-scheduler"></a>
</h3>
<p>A common strategy to deal with the learning rate problem is to start
with a high learning rate, and if the loss does not decrease, the
learning rate is reduced according to a specific plan.</p>
<p>I favor the “reduce learning rate on plateau” scheduler. If a loss
plateau isn’t resolved for a certain number of epochs (patience), the
learning rate will be reduced
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><msub><mi>r</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><mo>=</mo><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo>*</mo><mi>l</mi><msub><mi>r</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">lr_{new} = factor * lr_{old}</annotation></semantics></math>):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nn.fit_high</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html" class="external-link">iris</a></span>,</span>
<span>                  lr <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>                  epochs <span class="op">=</span> <span class="fl">60L</span>,</span>
<span>                  loss <span class="op">=</span> <span class="st">"softmax"</span>,</span>
<span>                  lr_scheduler <span class="op">=</span> <span class="fu"><a href="../reference/config_lr_scheduler.html">config_lr_scheduler</a></span><span class="op">(</span><span class="st">"reduce_on_plateau"</span>, patience <span class="op">=</span> <span class="fl">5</span>, factor <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: 0.868813, lr: 0.20000</span></span></code></pre></div>
<p><img src="B%2FB-unnamed-chunk-8-1.png" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; Loss at epoch 2: 0.607227, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 3: 1.129801, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 4: 0.498109, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 5: 0.427480, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 6: 0.505962, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 7: 0.423542, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 8: 0.398008, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 9: 0.415886, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 0.310365, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 11: 0.364727, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 12: 0.405762, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 13: 0.371685, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 14: 0.606758, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 15: 0.494564, lr: 0.20000</span></span>
<span><span class="co">#&gt; Loss at epoch 16: 0.386717, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 17: 0.247253, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 18: 0.196016, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 19: 0.216442, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 0.229231, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 21: 0.147426, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 22: 0.168880, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 23: 0.290900, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 24: 0.279733, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 25: 0.181382, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 26: 0.274826, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 27: 0.122269, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 28: 0.278979, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 29: 0.145546, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 30: 0.232280, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 31: 0.360600, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 32: 0.133818, lr: 0.10000</span></span>
<span><span class="co">#&gt; Loss at epoch 33: 0.133925, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 34: 0.117416, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 35: 0.097019, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 36: 0.095766, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 37: 0.085271, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 38: 0.081865, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 39: 0.087199, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 40: 0.086238, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 41: 0.115600, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 42: 0.101273, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 43: 0.081162, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 44: 0.093478, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 45: 0.078520, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 46: 0.112726, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 47: 0.112692, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 48: 0.093684, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 49: 0.100669, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 50: 0.081393, lr: 0.05000</span></span>
<span><span class="co">#&gt; Loss at epoch 51: 0.110707, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 52: 0.079502, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 53: 0.074759, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 54: 0.071895, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 55: 0.071452, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 56: 0.072424, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 57: 0.073547, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 58: 0.073571, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 59: 0.075333, lr: 0.02500</span></span>
<span><span class="co">#&gt; Loss at epoch 60: 0.071900, lr: 0.02500</span></span></code></pre>
<p>At the end of the training, the learning rate is 0.025</p>
<p>Note: The learning rate scheduler is a powerful approach to improve
the likeliness of convergence, BUT it cannot help with much too high
learning rates!</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nn.fit_high</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Species</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/iris.html" class="external-link">iris</a></span>,</span>
<span>                  lr <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                  epochs <span class="op">=</span> <span class="fl">60L</span>,</span>
<span>                  loss <span class="op">=</span> <span class="st">"softmax"</span>,</span>
<span>                  lr_scheduler <span class="op">=</span> <span class="fu"><a href="../reference/config_lr_scheduler.html">config_lr_scheduler</a></span><span class="op">(</span><span class="st">"reduce_on_plateau"</span>, patience <span class="op">=</span> <span class="fl">5</span>, factor <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loss at epoch 1: 782.251417, lr: 2.00000</span></span></code></pre></div>
<p><img src="B%2FB-unnamed-chunk-9-1.png" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; Loss at epoch 2: 3298.952477, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 3: 258.680795, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 4: 90.482500, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 5: 25.033280, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 6: 14.902886, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 7: 14.502181, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 8: 11.076120, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 9: 12.562866, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 10: 11.093193, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 11: 9.510224, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 12: 12.989465, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 13: 13.282229, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 14: 9.262714, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 15: 9.705650, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 16: 14.090702, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 17: 12.523569, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 18: 12.015066, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 19: 14.319363, lr: 2.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 20: 9.328203, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 21: 7.450138, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 22: 5.726156, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 23: 5.152872, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 24: 6.538125, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 25: 4.690747, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 26: 4.736277, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 27: 6.920749, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 28: 6.986071, lr: 1.00000</span></span>
<span><span class="co">#&gt; Loss at epoch 29: 4.831617, lr: 1.00000</span></span>
<span><span class="co">#&gt; Cancel training because loss is still above baseline, please hyperparameters. See vignette('B-Training_neural_networks') for help.</span></span></code></pre>
<p>Although the learning rate ended up being 0.01562, the loss never
outperformed the baseline loss. The optimizer jumped right at the
beginning into a completely unrealistic solution space for the
parameters of the NN, from which we could not recover.</p>
</div>
</div>
<div class="section level2">
<h2 id="overfitting">Overfitting<a class="anchor" aria-label="anchor" href="#overfitting"></a>
</h2>
<p>Overfitting means that the model fits the training data well, but
generalizes poorly to new observations. We can use the validation
argument to detect overfitting. If the validation loss starts to
increase again at a certain point, it often means that the models are
starting to overfit your training data:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/TheoreticalEcology/" class="external-link">EcoData</a></span><span class="op">)</span> <span class="co"># can be install from github using devtools::install_github(repo = "TheoreticalEcology/EcoData", dependencies = FALSE, build_vignettes = FALSE)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="va">elephant</span><span class="op">$</span><span class="va">occurenceData</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Presence</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">df</span>, lr <span class="op">=</span> <span class="fl">0.03</span>, epochs <span class="op">=</span> <span class="fl">600L</span>, loss <span class="op">=</span> <span class="st">"binomial"</span>, validation <span class="op">=</span> <span class="fl">0.2</span>,  hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">350L</span>, <span class="fl">350L</span>, <span class="fl">350L</span><span class="op">)</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, batchsize <span class="op">=</span> <span class="fl">150L</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="B%2FB-unnamed-chunk-10-1.png" style="display: block; margin: auto;"></p>
<p><strong>Solutions</strong>:</p>
<ul>
<li><p>Re-train with epochs = point where model started to
overfit</p></li>
<li><p>Early stopping, stop training when model starts to overfit, can
be specified using the <code>⁠early_stopping=…⁠</code> argument</p></li>
<li><p>Use regularization (dropout or elastic-net, see next
section)</p></li>
</ul>
<div class="section level3">
<h3 id="early-stopping-and-regularization">Early stopping and regularization<a class="anchor" aria-label="anchor" href="#early-stopping-and-regularization"></a>
</h3>
<p>Early stopping = stop training when validation loss cannot be
improved for x epochs (if there is no validation split, the training
loss is used).</p>
<p>lambda = 0.001 is the regularization strength and alpha = 0.2 means
that 20% L1 and 80% L2 weighting.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/dnn.html">dnn</a></span><span class="op">(</span><span class="va">Presence</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">df</span>, lr <span class="op">=</span> <span class="fl">0.03</span>, epochs <span class="op">=</span> <span class="fl">600L</span>, loss <span class="op">=</span> <span class="st">"binomial"</span>, validation <span class="op">=</span> <span class="fl">0.2</span>,  hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">350L</span>, <span class="fl">350L</span>, <span class="fl">350L</span><span class="op">)</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, batchsize <span class="op">=</span> <span class="fl">150L</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">TRUE</span>, early_stopping <span class="op">=</span> <span class="fl">10</span>, lambda <span class="op">=</span> <span class="fl">0.001</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="B%2FB-unnamed-chunk-11-1.png" style="display: block; margin: auto;"></p>
<p>The training is aborted!</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christian Amesöder, Maximilian Pichler.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
