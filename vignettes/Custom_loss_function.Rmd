---
title: "Species distribution modeling with cito"
author: "Maximilian Pichler"
date: "`r Sys.Date()`"
output:
  
 rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Introduction_to_cito}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Custom loss functions
We can pass custom loss functions to cito, R variables/values that are used within the function and that should be additionally optimized must be passed to cito via the custom_parameters function:

What we can do with it:

- (Complex) likelihood functions
- Advaced: Quantile regression
- JSDMs...


### Example 1: Custom likelihood functions

Poisson regression (Al:

```{r}



```



### Example 2: Quantile regression
```{r}
library(torch)

q1 = torch_tensor(0.05)
q2 = torch_tensor(0.5)
q3 = torch_tensor(0.95)
loss_func = function(pred, true,...) {
  l1 = torch_max(q1*(true[,1,drop=FALSE]-pred[,1,drop=FALSE]), other = (1.0-q1)*(pred[,1,drop=FALSE]-true[,1,drop=FALSE]))
  l2 = torch_max(q2*(true[,2,drop=FALSE]-pred[,2,drop=FALSE]), other = (1.0-q2)*(pred[,2,drop=FALSE]-true[,2,drop=FALSE]))
  l3 = torch_max(q3*(true[,3,drop=FALSE]-pred[,3,drop=FALSE]), other = (1.0-q3)*(pred[,3,drop=FALSE]-true[,3,drop=FALSE]))
  return(l1+l2+l3)
}

sim_in = function(n = 5) {
  S = diag(1., 3)
  S[1,2]=S[2,1]=0.0
  X = mvtnorm::rmvnorm(n, sigma = S)
  X1 = X[,1]
  C = X[,2]
  X2 = X[,3]
  Y = 1*X1 + 0.1*X2 + 0.0*C + rnorm(n, sd = 0.3+2*1.8^(X1+1))
  return(data.frame(Y = Y, X1 = X1, X2 = X2, C = C))
}

data = sim_in(500L)

m = dnn(cbind(Y, Y, Y)~., data = data, 
        lr = 0.01,
        loss = loss_func,
        lambda = 0.000, alpha = 0.5,
        epochs = 70L, hidden = c(30L, 30L), 
        activation = "selu", verbose = TRUE, plot = FALSE)

plot(data$X1, data$Y)
lines(smooth.spline(data$X1, predict(m)[,1], spar = 0.01), col = "green")
lines(smooth.spline(data$X1, predict(m)[,3], spar = 0.01), col = "green")
lines(smooth.spline(data$X1, predict(m)[,2], spar = 0.01), col = "green")

eff = diag(marginalEffectsGeneric(m, data = data[,-1], predict_func = function(object, newdata) cito:::predict.citodnn(object, newdata)[,2])$mean)
eff


```

